name: Expand GitBook Aliases

on:
  pull_request:

permissions:
  contents: write

jobs:
  expand-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Expand GitBook aliases (exclude README.md)
        run: |
          set -e

          echo "Expanding GitBook aliases (excluding README.md)..."

          find . -type f -name "*.md" ! -name "README.md" -print0 | xargs -0 sed -i \
            -e 's|{server}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/SsmexDFPv2xG2OTyO5yV|g' \
            -e 's|{galera}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/3VYeeVGUV4AMqrA3zwy7|g' \
            -e 's|{maxscale}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/0pSbu5DcMSW4KwAkUcmX|g' \
            -e 's|{analytics}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/rBEU9juWLfTDcdwF3Q14|g' \
            -e 's|{columnstore}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/2I4jZ8pGq8bT4w5n3q6r|g' \
            -e 's|{skysql}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/aEnK0ZXmUbJzqQrTjFyb|g' \
            -e 's|{home}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/gmXC0YXB3rRhXvpg5mb1|g' \
            -e 's|{platform}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/JqgUabdZsoY5EiaJmqgn|g' \
            -e 's|{connectors}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/CjGYMsT2MVP4nd3IyW2L|g' \
            -e 's|{tools}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/kuTXWg0NDbRx6XUeYpGD|g' \
            -e 's|{mariadb-cloud}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/vPz15Lz0Iw3P3yKR3Prd|g' \
            -e 's|{release-notes}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/aEnK0ZXmUbJzqQrTjFyb|g' \
            -e 's|{general-resources}|https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/WCInJQ9cmGjq1lsTG91E/about/readme|g'

          echo "Git status after expansion:"
          git status --short

      - name: Commit changes back to PR branch (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          if git diff --quiet; then
            echo "No alias replacements needed."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git commit -am "docs: expand GitBook aliases"

          echo "Pushing changes back to PR branch: $GITHUB_HEAD_REF"
          git push origin HEAD:$GITHUB_HEAD_REF
