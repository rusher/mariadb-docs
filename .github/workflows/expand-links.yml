name: Expand Cross-Space Links (DOCS-5904)

on:
  pull_request:
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  expand-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0 

      - name: Fix Git Context
        # CRITICAL FIX: Fetch the base branch so 'git diff' has something to compare against
        run: git fetch origin ${{ github.base_ref }}

      - name: Replace Link Aliases (Robust)
        shell: bash
        run: |
          # 1. CONFIGURATION
          declare -A LINKS
          LINKS["{server}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/SsmexDFPv2xG2OTyO5yV"
          LINKS["{maxscale}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/0pSbu5DcMSW4KwAkUcmX"
          LINKS["{analytics}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/rBEU9juWLfTDcdwF3Q14"
          LINKS["{galera}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/3VYeeVGUV4AMqrA3zwy7"

          # 2. DETECT CHANGES
          # We explicitly compare the Base Branch vs the Head to find modified existing files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep '\.md$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚ö†Ô∏è No markdown files detected in this diff."
            exit 0
          fi

          echo "üîé Scanning the following files:"
          echo "$CHANGED_FILES"
          echo "-----------------------------------"

          # 3. EXECUTION
          files_modified=0
          
          # Iterate through aliases first, then files
          for alias in "${!LINKS[@]}"; do
            target="${LINKS[$alias]}"
            
            # Read files line by line to handle names safely
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                # Check if file contains the alias
                if grep -Fq "$alias" "$file"; then
                  echo "  üëâ Found $alias in $file... Replacing."
                  # Escape the alias for sed ensuring regex doesn't break
                  sed -i "s|$alias|$target|g" "$file"
                  files_modified=$((files_modified+1))
                fi
              fi
            done <<< "$CHANGED_FILES"
          done

          if [ "$files_modified" -eq 0 ]; then
             echo "‚úÖ Scanned files, but no aliases found to replace."
          else
             echo "üöÄ Replaced aliases in $files_modified instances."
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: expand cross-space link aliases [skip ci]"
          file_pattern: "*.md"