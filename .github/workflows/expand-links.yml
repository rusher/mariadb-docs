name: Expand Links (Manual Fixer)

on:
  workflow_dispatch: # Button click trigger
  pull_request:
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  fix-all-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Run Global Search & Replace (With Exclusions)
        shell: bash
        run: |
          # ========================================================
          # 1. CONFIGURATION
          # ========================================================
          declare -A LINKS
          LINKS["{server}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/SsmexDFPv2xG2OTyO5yV"
          LINKS["{maxscale}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/0pSbu5DcMSW4KwAkUcmX"
          LINKS["{analytics}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/rBEU9juWLfTDcdwF3Q14"
          LINKS["{galera}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/3VYeeVGUV4AMqrA3zwy7"

          # ‚ö†Ô∏è ADD FILES TO EXCLUDE HERE
          # (Partial matches work: "legacy" will exclude "folder/legacy/file.md")
          declare -a EXCLUDE_LIST=(
            "mariadb-cloud/legacy-file.md"
            "do-not-touch.md"
            "archive/"
          )

          # ========================================================
          # 2. EXECUTION
          # ========================================================
          echo "üîé Scanning repository..."
          files_changed=0

          # Find all .md files (excluding .git)
          while IFS= read -r file; do
            
            # --- Exclusion Logic ---
            skip_file=false
            for exclude in "${EXCLUDE_LIST[@]}"; do
              if [[ "$file" == *"$exclude"* ]]; then
                echo "  ‚è≠Ô∏è SKIPPING (Excluded): $file"
                skip_file=true
                break
              fi
            done
            if [ "$skip_file" = true ]; then continue; fi
            # -----------------------

            # Process the file
            for alias in "${!LINKS[@]}"; do
              target="${LINKS[$alias]}"
              if grep -Fq "$alias" "$file"; then
                echo "  üëâ FIXING: $alias found in $file"
                sed -i "s@$alias@$target@g" "$file"
                files_changed=$((files_changed+1))
              fi
            done

          done < <(find . -name "*.md" -not -path "./.git/*")

          if [ "$files_changed" -eq 0 ]; then
            echo "‚úÖ Repository is clean."
          else
            echo "üöÄ Fixed aliases in $files_changed files."
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: global link expansion fix [skip ci]"
          file_pattern: "*.md"