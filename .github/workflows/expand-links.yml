name: Expand Cross-Space Links (DOCS-5904)

on:
  pull_request:
    paths:
      - '**.md' # Only runs when Markdown files are changed

permissions:
  contents: write # Needed to push the fixed links back to the PR

jobs:
  expand-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0 # IMPORTANT: Needed to compare commits for git diff

      - name: Replace Link Aliases (Changed Files Only)
        shell: bash
        run: |
          # ========================================================
          # 1. CONFIGURATION
          # ========================================================
          declare -A LINKS
          LINKS["{server}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/SsmexDFPv2xG2OTyO5yV"
          LINKS["{maxscale}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/0pSbu5DcMSW4KwAkUcmX"
          LINKS["{analytics}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/rBEU9juWLfTDcdwF3Q14"
          LINKS["{galera}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/3VYeeVGUV4AMqrA3zwy7"

          # ========================================================
          # 2. IDENTIFY CHANGED FILES
          # ========================================================
          # Get list of .md files changed in this PR compared to the base branch
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep '\.md$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed. Exiting."
            exit 0
          fi

          echo "ðŸ“ Analyzing the following changed files:"
          echo "$CHANGED_FILES"

          # ========================================================
          # 3. EXECUTION LOOP
          # ========================================================
          has_changes=false

          for alias in "${!LINKS[@]}"; do
            target="${LINKS[$alias]}"
            
            # Loop specifically through the changed files list
            while IFS= read -r file; do
              # Check if the file still exists (it might have been deleted) AND contains the alias
              if [ -f "$file" ] && grep -q "$alias" "$file"; then
                echo "  -> Expanding $alias in $file"
                sed -i "s|$alias|$target|g" "$file"
                has_changes=true
              fi
            done <<< "$CHANGED_FILES"
          done

          if [ "$has_changes" = false ]; then
            echo "âœ… No aliases found in changed files."
          fi

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: expand cross-space link aliases [skip ci]"
          file_pattern: "*.md"