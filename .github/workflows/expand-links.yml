name: Expand Links (Global Fix)

on:
  workflow_dispatch: # Button to run manually
  pull_request:
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  fix-all-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Run Global Search & Replace
        shell: bash
        run: |
          # 1. CONFIGURATION
          declare -A LINKS
          LINKS["{server}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/SsmexDFPv2xG2OTyO5yV"
          LINKS["{maxscale}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/0pSbu5DcMSW4KwAkUcmX"
          LINKS["{analytics}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/rBEU9juWLfTDcdwF3Q14"
          LINKS["{galera}"]="https://app.gitbook.com/o/diTpXxF5WsbHqTReoBsS/s/3VYeeVGUV4AMqrA3zwy7"

          echo "ðŸ”Ž Scanning ENTIRE repository..."
          files_changed=0

          # 2. FIND ALL MARKDOWN FILES (Recursive)
          # We use process substitution to avoid subshell issues
          while IFS= read -r file; do
            modified=false
            for alias in "${!LINKS[@]}"; do
              target="${LINKS[$alias]}"
              if grep -Fq "$alias" "$file"; then
                # Use @ as delimiter to prevent table pipe conflicts
                sed -i "s@$alias@$target@g" "$file"
                modified=true
              fi
            done
            
            if [ "$modified" = true ]; then
              echo "  ðŸ‘‰ Fixed: $file"
              files_changed=$((files_changed+1))
            fi
          done < <(find . -type f -name "*.md" -not -path "./.git/*")

          echo "------------------------------------------------"
          echo "ðŸš€ Modified $files_changed files."

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: global link expansion fix [skip ci]"
          # CRITICAL FIX: Use recursive glob pattern to catch files in subfolders
          file_pattern: "**/*.md"